---
import AuthenticatedLayout from '../layouts/AuthenticatedLayout.astro';

export const prerender = false;
---

<AuthenticatedLayout title="Character Select - Density Dwarf">
  <div class="character-select-screen">
    <h1>Character Select</h1>
    <p class="subtitle">Choose your character or create a new one</p>

    <div id="loading" class="status-message">
      <div class="spinner"></div>
      <p>Loading characters...</p>
    </div>

    <div id="error" class="status-message hidden">
      <p class="error-text">Failed to load characters</p>
      <p class="error-detail" id="error-message"></p>
      <button id="retry-button">Retry</button>
    </div>

    <div id="character-slots" class="character-slots hidden">
      <!-- Character slots will be populated by JavaScript -->
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal hidden">
      <div class="modal-content">
        <h2>Delete Character?</h2>
        <p>Are you sure you want to delete <strong id="delete-character-name"></strong>?</p>
        <p class="warning">This action cannot be undone.</p>
        <div class="modal-buttons">
          <button id="confirm-delete" class="button button-danger">Delete</button>
          <button id="cancel-delete" class="button button-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</AuthenticatedLayout>

<style>
  .character-select-screen {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 2rem;
  }

  h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    text-align: center;
  }

  .subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 2rem;
    text-align: center;
  }

  .status-message {
    text-align: center;
    margin: 2rem 0;
  }

  .status-message.hidden {
    display: none;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .error-text {
    color: #ffcccc;
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
  }

  .error-detail {
    color: #ffcccc;
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  #retry-button {
    padding: 0.75rem 2rem;
    background: white;
    color: #1e3c72;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s;
  }

  #retry-button:hover {
    transform: scale(1.05);
  }

  .character-slots {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    max-width: 900px;
    width: 100%;
  }

  .character-slot {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 2rem;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    position: relative;
  }

  .character-slot:hover {
    border-color: rgba(255, 255, 255, 0.5);
    background: rgba(255, 255, 255, 0.15);
  }

  .slot-number {
    position: absolute;
    top: 1rem;
    left: 1rem;
    font-size: 0.9rem;
    opacity: 0.6;
  }

  .character-info {
    text-align: center;
    cursor: pointer;
    width: 100%;
  }

  .character-name {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  .character-details {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-bottom: 1rem;
  }

  .delete-button {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .delete-button:hover {
    background: #d32f2f;
    transform: scale(1.05);
  }

  .create-button {
    display: inline-block;
    padding: 1rem 2rem;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
  }

  .create-button:hover {
    background: #45a049;
    transform: translateY(-2px);
  }

  .empty-slot {
    text-align: center;
  }

  .empty-slot-text {
    font-size: 1.1rem;
    opacity: 0.6;
    margin-bottom: 1rem;
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal.hidden {
    display: none;
  }

  .modal-content {
    background: #1e3c72;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 2rem;
    max-width: 400px;
    text-align: center;
  }

  .modal-content h2 {
    margin-bottom: 1rem;
    font-size: 1.8rem;
  }

  .modal-content p {
    margin-bottom: 1rem;
  }

  .warning {
    color: #ffcccc;
    font-size: 0.9rem;
    margin-bottom: 2rem !important;
  }

  .modal-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  .button {
    padding: 0.75rem 2rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .button-danger {
    background: #f44336;
    color: white;
  }

  .button-danger:hover {
    background: #d32f2f;
  }

  .button-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
  }

  .button-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  @media (max-width: 768px) {
    .character-slots {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  interface Character {
    character_id: string;
    character_name: string;
    level: number;
    slot: number;
    class_id: string;
    texture_id: string;
  }

  let characters: Character[] = [];
  let deleteCharacterId: string | null = null;

  async function loadCharacters() {
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const slotsEl = document.getElementById('character-slots');
    const errorMessageEl = document.getElementById('error-message');

    try {
      loadingEl?.classList.remove('hidden');
      errorEl?.classList.add('hidden');
      slotsEl?.classList.add('hidden');

      const response = await fetch('/api/characters');
      if (!response.ok) {
        throw new Error(`Failed to load characters: ${response.statusText}`);
      }

      characters = await response.json();

      loadingEl?.classList.add('hidden');
      slotsEl?.classList.remove('hidden');

      renderCharacterSlots();
    } catch (error) {
      console.error('Error loading characters:', error);

      loadingEl?.classList.add('hidden');
      errorEl?.classList.remove('hidden');

      if (errorMessageEl) {
        errorMessageEl.textContent = error instanceof Error ? error.message : 'Unknown error';
      }
    }
  }

  function renderCharacterSlots() {
    const slotsEl = document.getElementById('character-slots');
    if (!slotsEl) return;

    slotsEl.innerHTML = '';

    for (let slot = 0; slot < 4; slot++) {
      const character = characters.find(c => c.slot === slot);
      const slotEl = document.createElement('div');
      slotEl.className = 'character-slot';

      const slotNumber = document.createElement('div');
      slotNumber.className = 'slot-number';
      slotNumber.textContent = `Slot ${slot + 1}`;
      slotEl.appendChild(slotNumber);

      if (character) {
        // Filled slot
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-button';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          showDeleteModal(character);
        };
        slotEl.appendChild(deleteBtn);

        const infoDiv = document.createElement('div');
        infoDiv.className = 'character-info';
        infoDiv.onclick = () => {
          window.location.href = `/character-selected/${character.character_id}`;
        };

        const nameDiv = document.createElement('div');
        nameDiv.className = 'character-name';
        nameDiv.textContent = character.character_name;
        infoDiv.appendChild(nameDiv);

        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'character-details';
        detailsDiv.textContent = `Level ${character.level} ${character.class_id}`;
        infoDiv.appendChild(detailsDiv);

        slotEl.appendChild(infoDiv);
      } else {
        // Empty slot
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'empty-slot';

        const emptyText = document.createElement('p');
        emptyText.className = 'empty-slot-text';
        emptyText.textContent = 'Empty Slot';
        emptyDiv.appendChild(emptyText);

        const createBtn = document.createElement('a');
        createBtn.href = `/character-create?slot=${slot}`;
        createBtn.className = 'create-button';
        createBtn.textContent = 'Create Character';
        emptyDiv.appendChild(createBtn);

        slotEl.appendChild(emptyDiv);
      }

      slotsEl.appendChild(slotEl);
    }
  }

  function showDeleteModal(character: Character) {
    const modal = document.getElementById('delete-modal');
    const nameEl = document.getElementById('delete-character-name');

    if (modal && nameEl) {
      deleteCharacterId = character.character_id;
      nameEl.textContent = character.character_name;
      modal.classList.remove('hidden');
    }
  }

  function hideDeleteModal() {
    const modal = document.getElementById('delete-modal');
    if (modal) {
      modal.classList.add('hidden');
      deleteCharacterId = null;
    }
  }

  async function deleteCharacter() {
    if (!deleteCharacterId) return;

    try {
      const response = await fetch(`/api/characters/${deleteCharacterId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Failed to delete character');
      }

      hideDeleteModal();
      await loadCharacters();
    } catch (error) {
      console.error('Error deleting character:', error);
      alert('Failed to delete character. Please try again.');
    }
  }

  // Event listeners
  document.getElementById('retry-button')?.addEventListener('click', loadCharacters);
  document.getElementById('confirm-delete')?.addEventListener('click', deleteCharacter);
  document.getElementById('cancel-delete')?.addEventListener('click', hideDeleteModal);

  // Close modal on background click
  document.getElementById('delete-modal')?.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      hideDeleteModal();
    }
  });

  // Load characters on page load
  loadCharacters();
</script>
</AuthenticatedLayout>
